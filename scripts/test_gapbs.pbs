#!/bin/bash
#PBS -N PageRank_Benchmark_GAPBS
#PBS -j oe
#PBS -o gapbs.txt
#PBS -e gapbs.txt
#PBS -q short_cpuQ
#PBS -l walltime=1:00:00
#PBS -l select=1:ncpus=64:mem=16gb

cd $PBS_O_WORKDIR

# Ensure binaries exist
if [ ! -x "comparison/gapbs/pr_spmv" ]; then
    echo "Error: 'pr_spmv' binary not found or not executable."
    exit 1
fi

mkdir -p results

STATS_FILE="results/gapbs_stats.txt"
DATASETS=(stanford google)
PLACES=(threads)
BIND=(spread)

module load perf || echo "Perf module not found, continuing without it..."

for bind in "${BIND[@]}"; do
    for place in "${PLACES[@]}"; do
        for threads in 1 2 4 8 16 32 64; do
            export OMP_NUM_THREADS=$threads
            export OMP_PROC_BIND=$bind
            export OMP_PLACES=$place
            
            for dataset in "${DATASETS[@]}"; do
                echo "GAPBS bind=${bind} place=${place} threads=${threads} dataset=${dataset}" >> $STATS_FILE
                perf stat -e cache-references,cache-misses,cycles,instructions \
                    comparison/gapbs/pr_spmv -f "datasets/${dataset}.el" -t 0.000001 -n 10 -i 1000 >> $STATS_FILE 2>&1
            done
        done
    done
done

echo "GAPBS Test Finished"
echo ""
