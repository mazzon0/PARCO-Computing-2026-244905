#!/bin/bash
#PBS -N pagerank_test
#PBS -o output.txt
#PBS -e error.txt
#PBS -q short_cpuQ
#PBS -l walltime=0:02:00
#PBS -l select=1:ncpus=1
#PBS -l mem=8gb

set -euo pipefail

if [ "$#" -lt 2 ]; then
    echo "Usage: qsub $0 -- <program> <graph> [program args...]"
    exit 1
fi

program=$1
graph=$2
shift 2
program_args="$@"

CORES=${PBS_NCPUS:-1}
export OMP_NUM_THREADS=$CORES

STATS_FILE="stats.txt"
BIN="./bin/${program}"

if [ ! -x "$BIN" ]; then
    echo "Error: executable $BIN not found or not executable"
    exit 1
fi

echo "----------------------------------------" >> "$STATS_FILE"
echo "Program: $program" >> "$STATS_FILE"
echo "Graph:   $graph" >> "$STATS_FILE"
echo "Args:    $program_args" >> "$STATS_FILE"
echo "Cores:   $CORES" >> "$STATS_FILE"
echo "Date:    $(date)" >> "$STATS_FILE"

perf stat \
    -e cache-references,cache-misses,cycles,instructions \
    "$BIN" "$graph" $program_args \
    >> "$STATS_FILE" 2>&1
